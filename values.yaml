# Default values for muze-web chart
# This is a YAML-formatted file.

global:
  environment: prod # 네임스페이스 이름으로 쓰려던 값
  project: muze
# Namespace 설정
namespace:
  name: web
  create: false
# ALB Controller 설정
albController:
  enabled: true
  serviceAccount:
    name: aws-load-balancer-controller
    namespace: kube-system
    roleArn: arn:aws:iam::620455725858:role/AmazonEKSLoadBalancerControllerRole
# Application 설정
application:
  name: muze-web
  replicaCount: 2
  image:
    repository: 620455725858.dkr.ecr.ap-northeast-2.amazonaws.com/muze
    tag: "f37a2"
    pullPolicy: Always
  imagePullSecrets:
    - name: ecr-secret
  container:
    port: 8000
  serviceAccount:
    enabled: true # Deployment.yaml에서 if문에 걸림
    name: muze-web-sa # 실제 존재하거나 Helm이 만들 SA 이름
    create: false # IRSA면 false (이미 존재)
# Service 설정 - ClusterIP + IP 모드로 변경
service:
  type: ClusterIP
  port: 80
  targetPort: 8000
# Health Check 추가
livenessProbe:
  enabled: true
  path: /
  initialDelaySeconds: 30
  periodSeconds: 10
  timeoutSeconds: 5
  failureThreshold: 3
readinessProbe:
  enabled: true
  path: /
  initialDelaySeconds: 10
  periodSeconds: 5
  timeoutSeconds: 3
  failureThreshold: 3
# ---------------------------------------
# Ingress (prod에만 적용)
# ---------------------------------------
ingress:
  enabled: true
  className: alb
  annotations:
    alb.ingress.kubernetes.io/scheme: internet-facing
    alb.ingress.kubernetes.io/target-type: ip # instance에서 ip로 변경
    alb.ingress.kubernetes.io/load-balancer-name: muze-prod-alb
    alb.ingress.kubernetes.io/listen-ports: '[{"HTTP":80},{"HTTPS":443}]'
    alb.ingress.kubernetes.io/ssl-redirect: '443'
    alb.ingress.kubernetes.io/group.name: muze-prod-group
    alb.ingress.kubernetes.io/group.order: "10"
  certificateArn: arn:aws:acm:ap-northeast-2:620455725858:certificate/d980c0cb-8540-4d44-bf77-46c527df9e7b
  hosts:
    - host: www.muz-e.com
      paths:
        - path: /
          pathType: Prefix
  externalDns:
    enabled: true
    hostname: www.muz-e.com
# External Services 설정 (prod 환경에만 적용)
externalServices:
  rds:
    enabled: true
    primary:
      name: rds-service-prod
      externalName: eks-rds.cjk6a0asc67f.ap-northeast-2.rds.amazonaws.com
    replica:
      name: rds-replica-prod
      externalName: eks-rds-replica.cjk6a0asc67f.ap-northeast-2.rds.amazonaws.com
  redis:
    enabled: true
    name: redis-service-prod
    externalName: muze-redis.kj5slr.ng.0001.apn2.cache.amazonaws.com
# External Secrets 설정 (prod 환경에만 적용)
externalSecrets:
  enabled: true # ⬅️ 새로 추가: External Secrets 사용 여부
  secretStore:
    name: aws-ssm-store # ⬅️ 선택: SecretStore 이름
    provider: ParameterStore # ⬅️ 선택: ParameterStore 또는 SecretsManager
    region: ap-northeast-2 # ⬅️ 변경: AWS 리전
  serviceAccount:
    name: muze-web-sa
    create: false # 이미 존재(IRSA)하면 false
  externalSecret:
    name: muze-app-secrets # ⬅️ 선택: 생성될 Secret 이름
    refreshInterval: 1h # ⬅️ 선택: SSM 동기화 주기 (1h, 5m, 30s 등)
    data:
      # Production SSM 경로
      - secretKey: SECRET_KEY
        remoteRef:
          key: /muze/prod/SECRET_KEY
      - secretKey: DB_NAME
        remoteRef:
          key: /muze/prod/DB_NAME
      - secretKey: DB_USER
        remoteRef:
          key: /muze/prod/DB_USER
      - secretKey: DB_PASSWORD
        remoteRef:
          key: /muze/prod/DB_PASSWORD
      - secretKey: DB_PORT
        remoteRef:
          key: /muze/prod/DB_PORT
      - secretKey: REDIS_PORT
        remoteRef:
          key: /muze/prod/REDIS_PORT
      - secretKey: REDIS_DB
        remoteRef:
          key: /muze/prod/REDIS_DB
      - secretKey: REDIS_PASS
        remoteRef:
          key: /muze/prod/REDIS_PASS
      - secretKey: WEB_S3_BUCKET_NAME
        remoteRef:
          key: /muze/prod/WEB_S3_BUCKET_NAME
      - secretKey: AWS_REGION
        remoteRef:
          key: /muze/prod/AWS_REGION
# ==========================================
# HPA 설정 (새로 추가)
# ==========================================

hpa:
  enabled: true
  minReplicas: 2
  maxReplicas: 5
  targetCPUUtilizationPercentage: 70
  targetMemoryUtilizationPercentage: 80
  # 스케일 다운 설정 (더 빠르게 축소)
  scaleDownStabilizationWindowSeconds: 60 # 기본 300초 → 60초로 단축
  scaleDownPercentage: 50 # 60초마다 최대 50% 축소 가능
  scaleDownPods: 1 # 또는 60초마다 최대 1개 Pod 축소
  scaleDownPeriodSeconds: 60
  # 스케일 업 설정 (빠르게 확장)
  scaleUpStabilizationWindowSeconds: 0 # 즉시 반응
  scaleUpPercentage: 100 # 15초마다 최대 100% 확장 가능
  scaleUpPods: 2 # 또는 15초마다 최대 2개 Pod 추가
  scaleUpPeriodSeconds: 15
# ---------------------------------------
# 리소스 설정 (prod와 다른 설정으로 변경)
# ---------------------------------------
resources:
  limits:
    memory: 512Mi
    cpu: 500m
  requests:
    memory: 512Mi
    cpu: 500m
